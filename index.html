<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <title>ROSARY RIDGEBED©®™ • 7 Gaben Hügelbeet Pyramide</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/three@0.167.1/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.167.1/examples/js/controls/OrbitControls.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.167.1/examples/js/exporters/STLExporter.js"></script>
  <style>
    body { margin:0; overflow:hidden; background:radial-gradient(circle at center,#0b1a33 0%,#000 100%); color:#fff; font-family:Arial,sans-serif; }
    #info,#controls{position:absolute;padding:15px;border-radius:12px;backdrop-filter:blur(12px);background:rgba(0,0,0,0.7);border:1px solid rgba(212,175,55,0.5);z-index:10;box-shadow:0 0 20px rgba(212,175,55,0.3);}
    #info{top:10px;left:10px;max-width:420px;}
    #controls{bottom:20px;left:20px;}
    }
    button{padding:10px 20px;margin:5px;background:linear-gradient(45deg,#d4af37,#ffd700);border:none;border-radius:8px;cursor:pointer;font-weight:bold;color:#000;transition:0.2s;}
    button:hover{transform:scale(1.05);}
    #modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.9);z-index:100;justify-content:center;align-items:center;backdrop-filter:blur(8px);}
    #modal-content{background:#111;padding:40px;border-radius:15px;border:2px solid #d4af37;max-width:600px;text-align:center;}
    .close{position:absolute;top:10px;right:20px;font-size:36px;cursor:pointer;color:#d4af37;}
  </style>
</head>
<body>
<div id="canvas-container"></div>

<div id="info">
  <h1 style="margin:0;color:#d4af37;text-shadow:0 0 10px gold">7 Gaben des Hl. Geistes – Goldener Weg</h1>
  <button onclick="toggleView()">Modus: Laien ↔ Forscher</button>
  <div id="laien"><p><b>Prinzip:</b> Hügel wächst spiralförmig (Fibonacci). Jede Schicht = eine Gabe.</p></div>
  <div id="forscher" style="display:none"><p>Rosenkranz-Approximation n=17→153<br>Skaleninvarianz S(r)=k·r^φ</p></div>
</div>

<div id="controls">
  <button onclick="resetCamera()">Ansicht zurück</button>
  <button onclick="toggleRotation()">Rotation an/aus</button>
  <button onclick="exportSTL()">3D-Druck STL</button>
</div>

<div id="modal" onclick="closeModal()">
  <div id="modal-content" onclick="event.stopPropagation()">
    <span class="close" onclick="closeModal()">×</span>
    <h2 id="modal-title" style="color:#ffd700"></h2>
    <hr style="border-color:#444">
    <p id="modal-psalm"></p>
    <p id="modal-denk" style="color:#d4af37;font-style:italic"></p>
  </div>
</div>

<script>
// Setup
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x001133);
scene.fog = new THREE.FogExp2(0x001133, 0.012);

const camera = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.1, 1000);
camera.position.set(12, 14, 20);

const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth, innerHeight);
renderer.setPixelRatio(devicePixelRatio);
renderer.shadowMap.enabled = true;
renderer.shadowMap.type = THREE.PCFSoftShadowMap;
renderer.toneMapping = THREE.ACESFilmicToneMapping;
document.getElementById('canvas-container').appendChild(renderer.domElement);

const controls = new THREE.OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;
controls.autoRotate = true;
controls.autoRotateSpeed = 0.5;

// Licht
scene.add(new THREE.AmbientLight(0xffffff, 0.6));
const sun = new THREE.DirectionalLight(0xfffaed, 4);
sun.position.set(20, 50, 20);
sun.castShadow = true;
sun.shadow.mapSize.width = 2048;
sun.shadow.mapSize.height = 2048;
scene.add(sun);
scene.add(new THREE.PointLight(0xffd700, 6, 40).setPosition(0,12,0));

// Gras-Textur (kein CORS)
function grass() {
  const c = document.createElement('canvas');
  c.width = c.height = 512;
  const ctx = c.getContext('2d');
  ctx.fillStyle = '#1a3a0b';
  ctx.fillRect(0,0,512,512);
  for(let i=0;i<8000;i++){
    ctx.fillStyle = Math.random()>0.5?'#2a5a1b':'#3a7a2b';
    ctx.fillRect(Math.random()*512,Math.random()*512,2+Math.random()*4,2+Math.random()*6);
  }
  const tex = new THREE.CanvasTexture(c);
  tex.wrapS = tex.wrapT = THREE.RepeatWrapping;
  tex.repeat.set(10,10);
  return tex;
}
const grassTex = grass();

// 7 Terrassen
const colors = [0x5c4033, 0x70503c, 0x5d4037, 0x4a3728, 0x3e2b1f, 0x2b1e16, 0x228b22];
const gaben = ["Furcht des Herrn","Frömmigkeit","Erkenntnis","Stärke","Rat","Verstand","Weisheit"];
const terraces = [];

for(let i=0; i<7; i++){
  const h = 2.8;
  const rTop = 10 - i*1.1;
  const rBot = 10 - (i-1)*1.1;
  const geo = new THREE.CylinderGeometry(i===6?rTop-0.5:rTop, rBot, h, 80, 1, false);
  const mat = i===6 ? new THREE.MeshStandardMaterial({map:grassTex, bumpMap:grassTex, bumpScale:0.4, roughness:0.85})
                    : new THREE.MeshStandardMaterial({color:colors[i], roughness:0.9, metalness:0.05});
  const mesh = new THREE.Mesh(geo, mat);
  mesh.position.y = -10 + i*h + h/2;
  mesh.castShadow = mesh.receiveShadow = true;
  mesh.userData.index = i;
  scene.add(mesh);
  terraces.push(mesh);
}

// Goldene Spirale
const points = [];
let r=0.3, a=0, y=-10;
for(let i=0;i<1600;i++){
  points.push(new THREE.Vector3(r*Math.cos(a), y, r*Math.sin(a)));
  a += 0.13;
  r += 0.0085;
  if(i%120===0) y += 0.75;
}
const spiral = new THREE.Mesh(
  new THREE.TubeGeometry(new THREE.CatmullRomCurve3(points), 1600, 0.28, 16, false),
  new THREE.MeshPhysicalMaterial({color:0xffd700, metalness:1, roughness:0.1, emissive:0xaa8800, emissiveIntensity:0.8})
);
spiral.castShadow = true;
scene.add(spiral);

// Spitze
const pyramid = new THREE.Mesh(
  new THREE.ConeGeometry(2, 5, 6),
  new THREE.MeshPhysicalMaterial({color:0xffd700, metalness:1, roughness:0.05, clearcoat:1})
);
pyramid.position.y = 10.5;
pyramid.castShadow = true;
scene.add(pyramid);

const starShape = new THREE.Shape();
for(let i=0;i<12;i++){
  const ang = i/6*Math.PI;
  const rad = i%2===0?2:1;
  i===0?starShape.moveTo(rad*Math.cos(ang),rad*Math.sin(ang)):starShape.lineTo(rad*Math.cos(ang),rad*Math.sin(ang));
}
const star = new THREE.Mesh(
  new THREE.ExtrudeGeometry(starShape,{depth:0.5,bevelEnabled:true,bevelThickness:0.2}),
  new THREE.MeshPhysicalMaterial({color:0xffd700, metalness:1, roughness:0.05})
);
star.rotation.x = -Math.PI/2;
star.position.y = 13.8;
star.castShadow = true;
scene.add(star);

// Modal-Daten
const data = [
  {psalm:"Psalm 111", text:"Die Furcht des Herrn ist der Weisheit Anfang.", denk:"Fundament-Gesetz"},
  {psalm:"Psalm 120", text:"In meiner Not rief ich zum Herrn …", denk:"Kingfisher-Gesetz"},
  {psalm:"Psalm 122", text:"Freut euch mit Jerusalem …", denk:"DiaKonos-Gesetz"},
  {psalm:"Psalm 124", text:"Wäre der Herr nicht bei uns …", denk:"Skaleninvarianz"},
  {psalm:"Psalm 126", text:"Die mit Tränen säen …", denk:"Hebel-Gesetz"},
  {psalm:"Psalm 130", text:"Aus den Tiefen rufe ich …", denk:"Coan-Paradoxon"},
  {psalm:"Psalm 134", text:"Segnet den Herrn …", denk:"Heureka – Vollendung"}
];

// Raycaster
const ray = new THREE.Raycaster();
const mouse = new THREE.Vector2();
window.addEventListener('pointerdown', e => {
  mouse.x = (e.clientX/innerWidth)*2-1;
  mouse.y = -(e.clientY/innerHeight)*2+1;
  ray.setFromCamera(mouse,camera);
  const hits = ray.intersectObjects(terraces);
  if(hits.length){
    const i = hits[0].object.userData.index;
    document.getElementById('modal-title').textContent = gaben[i];
    document.getElementById('modal-psalm').textContent = data[i].psalm + ": " + data[i].text;
    document.getElementById('modal-denk').textContent = "Denkgesetz: " + data[i].denk;
    document.getElementById('modal').style.display = 'flex';
    controls.autoRotate = false;
  }
});

// Funktionen
function exportSTL(){
  const exporter = new THREE.STLExporter();
  const result = exporter.parse(scene);
  const blob = new Blob([result], {type:'text/plain'});
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = 'rosary-7gaben.stl';
  link.click();
}
function toggleView(){
  const l = document.getElementById('laien');
  const f = document.getElementById('forscher');
  [l.style.display, f.style.display] = [f.style.display, l.style.display];
}
function resetCamera(){ camera.position.set(12,14,20); controls.target.set(0,3,0); controls.update(); }
function toggleRotation(){ controls.autoRotate = !controls.autoRotate; }
function closeModal(){ document.getElementById('modal').style.display='none'; controls.autoRotate=true; }

// Animate
function animate(){
  requestAnimationFrame(animate);
  star.rotation.y += 0.004;
  controls.update();
  renderer.render(scene,camera);
}
animate();

window.onresize = ()=>{
  camera.aspect = innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth,innerHeight);
};
</script>
</body>
</html>
