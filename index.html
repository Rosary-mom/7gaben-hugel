<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <title>ROSARY RIDGEBED ‚Ä¢ 7 Gaben H√ºgelbeet Pyramide</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/three@0.167.1/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.167.1/examples/js/controls/OrbitControls.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.167.1/examples/js/exporters/STLExporter.js"></script>
  
  <style>
    body { margin: 0; overflow: hidden; background: #001133; color: #fff; font-family: 'Segoe UI', Arial, sans-serif; }
    
    /* UI Container */
    #info, #controls {
      position: absolute;
      padding: 20px;
      border-radius: 12px;
      backdrop-filter: blur(12px);
      border: 1px solid rgba(212, 175, 55, 0.5);
      background: rgba(0, 0, 0, 0.7);
      z-index: 10;
      box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
    }
    
    #info { top: 10px; left: 10px; max-width: 420px; }
    #controls { bottom: 20px; left: 20px; }
    
    /* Buttons */
    button {
      padding: 10px 20px;
      margin: 5px;
      background: linear-gradient(45deg, #d4af37, #ffd700);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      color: #000;
      transition: transform 0.2s;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
    }
    button:hover { transform: scale(1.05); background: linear-gradient(45deg, #ffd700, #fff); }
    
    /* Modal (Pop-up) */
    #modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.85);
      z-index: 100;
      justify-content: center;
      align-items: center;
      backdrop-filter: blur(5px);
    }
    #modal-content {
      background: #1a1a1a;
      padding: 40px;
      border-radius: 15px;
      border: 2px solid #d4af37;
      max-width: 600px;
      text-align: center;
      position: relative;
      box-shadow: 0 0 50px rgba(212, 175, 55, 0.2);
    }
    .close {
      position: absolute;
      top: 10px;
      right: 20px;
      font-size: 40px;
      cursor: pointer;
      color: #d4af37;
    }
    
    /* Typografie */
    h1 { margin: 0 0 10px 0; color: #d4af37; text-shadow: 0 0 10px rgba(212, 175, 55, 0.5); font-size: 1.5rem; }
    p { line-height: 1.5; }
  </style>
</head>
<body>

<div id="canvas-container"></div>

<div id="info">
  <h1>7 Gaben des Hl. Geistes<br><span style="font-size:0.7em; color:#fff;">Goldener Weg & Rosary Ridgebed</span></h1>
  <button onclick="toggleView()">Modus: Laien ‚Üî Forscher</button>
  
  <div id="laien">
    <p><b>Das Prinzip:</b> Der H√ºgel w√§chst spiralf√∂rmig wie ein Schneckenhaus üêå (Fibonacci).<br>Jede Ebene steht f√ºr eine der 7 Gaben ‚Äì beginnend bei der Demut (Furcht des Herrn) bis zur Weisheit an der Spitze.</p>
    <p style="font-size:0.9em; color:#aaa;"><i>Klicken Sie auf die Ebenen f√ºr Details.</i></p>
  </div>
  
  <div id="forscher" style="display:none">
    <p><b>Rosenkranz-Approximation n=17 ‚Üí 153</b></p>
    <p style="font-family: monospace; background:rgba(0,0,0,0.5); padding:5px; border-radius:4px;">h ‚âà Œ£ binom(17,k) (1/œÜ)^k ¬∑ h^(k)(Q)</p>
    <p>Skaleninvarianz: S(r) = k ¬∑ r^œÜ<br>Hydrodynamische Optimierung durch Permakultur-Design.</p>
  </div>
</div>

<div id="controls">
  <button onclick="resetCamera()">Ansicht zur√ºcksetzen</button>
  <button onclick="toggleRotation()">Rotation an/aus</button>
  <button onclick="exportSTL()">üíæ 3D-Druck (STL)</button>
</div>

<div id="modal" onclick="closeModal()">
  <div id="modal-content" onclick="event.stopPropagation()">
    <span class="close" onclick="closeModal()">√ó</span>
    <h2 id="modal-title" style="color:#d4af37; margin-top:0;"></h2>
    <hr style="border-color:#333; margin: 15px 0;">
    <p id="modal-psalm" style="font-size: 1.1em;"></p>
    <p id="modal-denk" style="color:#d4af37; font-style:italic; margin-top:20px;"></p>
  </div>
</div>

<script>
// --- SETUP ---
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x001133);
// Nebel f√ºr Tiefe
scene.fog = new THREE.FogExp2(0x001133, 0.015);

const camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
camera.position.set(10, 15, 20);

const renderer = new THREE.WebGLRenderer({antialias:true, alpha: true});
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.setPixelRatio(window.devicePixelRatio);
document.getElementById('canvas-container').appendChild(renderer.domElement);

const controls = new THREE.OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;
controls.dampingFactor = 0.05;

let isRotating = true;
const terraces = [];

// --- TEXTUREN ---
const loader = new THREE.TextureLoader();
let grassMat = null;

// Fallback Farbe, falls Textur nicht l√§dt
loader.load('https://i.imgur.com/4tZEm8T.jpeg', 
  (texture) => {
    texture.wrapS = texture.wrapT = THREE.RepeatWrapping;
    texture.repeat.set(4, 1);
    grassMat = texture;
    // Materialien aktualisieren wenn Textur geladen ist
    terraces.forEach((mesh, i) => {
      if(i === 6) { 
        mesh.material.map = texture;
        mesh.material.bumpMap = texture;
        mesh.material.needsUpdate = true;
      }
    });
  },
  undefined,
  (err) => console.log("Textur konnte nicht geladen werden, nutze Farbe.")
);

// --- GEOMETRIE: 7 Schichten (H√ºgelbeet) ---
const colors = [0x8b4513, 0x8b5a2b, 0x228b22, 0x654321, 0x4b3621, 0x5d4037, 0x228b22];
const gaben = ["Furcht des Herrn", "Fr√∂mmigkeit", "Erkenntnis", "St√§rke", "Rat", "Verstand", "Weisheit"];

for(let i=0; i<7; i++){
  // Pyramidenartiger Aufbau
  const bottomRadius = 9 * (1 - i/8) + 1;
  const topRadius = 9 * (1 - (i+1)/8) + 1;
  const height = 1.5;
  
  const geo = new THREE.CylinderGeometry(topRadius, bottomRadius, height, 64);
  const mat = new THREE.MeshPhongMaterial({
    color: colors[i],
    shininess: 10,
    flatShading: false
  });
  
  const mesh = new THREE.Mesh(geo, mat);
  mesh.position.y = -5 + (i * height);
  mesh.userData = { id: i }; // ID speichern f√ºr Klick-Event
  scene.add(mesh);
  terraces.push(mesh);
  
  // Rand-Linien f√ºr bessere Sichtbarkeit
  const edges = new THREE.EdgesGeometry(geo);
  const line = new THREE.LineSegments(edges, new THREE.LineBasicMaterial({ color: 0x000000, transparent: true, opacity: 0.3 }));
  mesh.add(line);
}

// --- GOLDENE SPIRALE (Schlauch) ---
const points = [];
let rad = 0.1;
let angle = 0;
let yPos = -5;

// Fibonacci-artige Spirale nach oben
for(let i=0; i<1200; i++){
  points.push(new THREE.Vector3(rad * Math.cos(angle), yPos, rad * Math.sin(angle)));
  angle += 0.1;
  rad += 0.008;
  yPos += 0.012; 
}

const curve = new THREE.CatmullRomCurve3(points);
const tubeGeo = new THREE.TubeGeometry(curve, 600, 0.15, 8, false);
const tubeMat = new THREE.MeshPhongMaterial({ color: 0xffd700, emissive: 0xaa8800, shininess: 100 });
const spiral = new THREE.Mesh(tubeGeo, tubeMat);
scene.add(spiral);

// --- SPITZE: Salomonisches Siegel / Stern ---
const starShape = new THREE.Shape();
const outerRadius = 1.2;
const innerRadius = 0.6;
const spikes = 6; // Hexagramm

for(let i=0; i < spikes * 2; i++){
  const r = (i % 2 === 0) ? outerRadius : innerRadius;
  const a = (i / (spikes * 2)) * Math.PI * 2;
  if(i===0) starShape.moveTo(r * Math.cos(a), r * Math.sin(a));
  else starShape.lineTo(r * Math.cos(a), r * Math.sin(a));
}
starShape.closePath();

const starGeo = new THREE.ExtrudeGeometry(starShape, { depth: 0.2, bevelEnabled: true, bevelThickness: 0.05, bevelSize: 0.05, bevelSegments: 2 });
const goldMat = new THREE.MeshPhysicalMaterial({ 
  color: 0xffd700, 
  metalness: 0.7, 
  roughness: 0.2,
  clearcoat: 1.0
});

const star = new THREE.Mesh(starGeo, goldMat);
star.rotation.x = -Math.PI / 2;
star.position.set(0, 6.5, 0); // Oben auf der Spitze
scene.add(star);

// Kleines Leuchtfeuer oben drauf
const beaconGeo = new THREE.SphereGeometry(0.3, 16, 16);
const beaconMat = new THREE.MeshBasicMaterial({ color: 0xffffff });
const beacon = new THREE.Mesh(beaconGeo, beaconMat);
beacon.position.set(0, 0, 0.2); // Relativ zum Stern
star.add(beacon);


// --- LICHT ---
const ambientLight = new THREE.AmbientLight(0x404040, 2); 
scene.add(ambientLight);

const sunLight = new THREE.DirectionalLight(0xfffaed, 2);
sunLight.position.set(20, 50, 20);
scene.add(sunLight);

const goldLight = new THREE.PointLight(0xffd700, 5, 20);
goldLight.position.set(0, 8, 0);
scene.add(goldLight);


// --- INTERAKTION & DATEN ---
const data = [
  {psalm:"Psalm 111", text:"Die Furcht des Herrn ist der Weisheit Anfang.", denk:"Fundament-Gesetz"},
  {psalm:"Psalm 120", text:"Ich rufe zum Herrn in meiner Not...", denk:"Kingfisher-Gesetz"},
  {psalm:"Psalm 122", text:"Ich freute mich √ºber die, so mir sagten...", denk:"DiaKonos-Gesetz"},
  {psalm:"Psalm 124", text:"W√§re der Herr nicht bei uns...", denk:"Skaleninvarianz"},
  {psalm:"Psalm 126", text:"Die mit Tr√§nen s√§en, werden mit Freuden ernten.", denk:"Hebel-Gesetz"},
  {psalm:"Psalm 130", text:"Aus der Tiefe rufe ich, Herr, zu dir.", denk:"Coan-Paradoxon"},
  {psalm:"Psalm 139", text:"Erforsche mich, Gott, und erkenne mein Herz.", denk:"Heureka ‚Äì Vollendung"}
];

const raycaster = new THREE.Raycaster();
const mouse = new THREE.Vector2();

window.addEventListener('pointerdown', onMouseClick);

function onMouseClick(event) {
  // Mauskoordinaten normalisieren
  mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
  mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

  raycaster.setFromCamera(mouse, camera);
  const intersects = raycaster.intersectObjects(terraces);

  if (intersects.length > 0) {
    const id = intersects[0].object.userData.id;
    if (data[id]) {
      showModal(id);
    }
  }
}

// --- FUNKTIONEN ---

function showModal(index) {
  document.getElementById('modal-title').textContent = (index + 1) + ". " + gaben[index];
  document.getElementById('modal-psalm').textContent = data[index].psalm + ": \"" + data[index].text + "\"";
  document.getElementById('modal-denk').textContent = "Denkgesetz: " + data[index].denk;
  document.getElementById('modal').style.display = 'flex';
  isRotating = false; // Rotation stoppen beim Lesen
}

function closeModal() {
  document.getElementById('modal').style.display = 'none';
  isRotating = true;
}

function exportSTL(){
  const exporter = new THREE.STLExporter();
  // Nur Mesh-Objekte exportieren, keine Lichter/Kameras
  const stl = exporter.parse(scene);
  const blob = new Blob([stl], {type: 'text/plain'});
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = 'Rosary_Ridgebed_Model.stl';
  link.click();
}

function toggleView(){
  const l = document.getElementById('laien');
  const f = document.getElementById('forscher');
  if(l.style.display === 'none') {
    l.style.display = 'block';
    f.style.display = 'none';
  } else {
    l.style.display = 'none';
    f.style.display = 'block';
  }
}

function resetCamera() {
  camera.position.set(10, 15, 20);
  controls.reset();
}

function toggleRotation() {
  isRotating = !isRotating;
}

// --- ANIMATION LOOP ---
function animate() {
  requestAnimationFrame(animate);
  
  controls.update();

  if(isRotating) {
    // Ganze Szene leicht drehen oder nur die Spirale? 
    // Hier drehen wir die Kamera sanft um das Zentrum (via OrbitControls autoRotate w√§re auch m√∂glich)
    // Aber wir drehen hier manuell die Spirale und den Stern f√ºr Effekt
    spiral.rotation.y -= 0.001;
    star.rotation.z -= 0.005; // Stern dreht sich
  }

  renderer.render(scene, camera);
}

animate();

// Resize Handler
window.addEventListener('resize', () => {
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
});
</script>
</body>
</html>
